model User {
  id String @id @db.VarChar(255)

  name          String  @db.VarChar(120)
  firstName     String? @map("first_name") @db.VarChar(70)
  lastName      String? @map("last_name") @db.VarChar(70)
  email         String  @unique @db.VarChar(255)
  emailVerified Boolean @default(false) @map("email_verified")
  hasImage      Boolean @default(false) @map("has_image")
  image         String? @db.Text

  role             String?
  banned           Boolean?  @default(false)
  banReason        String?   @map("ban_reason")
  banExpires       DateTime? @map("ban_expires")
  twoFactorEnabled Boolean?  @default(false) @map("two_factor_enabled")
  lastLoginMethod  String?   @map("last_login_method")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations - Auth
  sessions   Session[]
  accounts   Account[]
  apikeys    Apikey[]
  twofactors TwoFactor[]

  // Relations - App (defined in app.prisma)
  links        Link[]
  subscription Subscription?
  settings     UserSettings?
  usageLimit   UsageLimit?

  // Indexes for performance
  @@index([email])
  @@index([role])
  @@index([banned])
  @@index([createdAt])
  @@map("users")
}

model Session {
  id        String   @id @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  token     String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.Text
  userId    String   @map("user_id") @db.VarChar(255)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy       String? @map("impersonated_by") @db.VarChar(255)
  activeOrganizationId String? @map("active_organization_id") @db.VarChar(255)

  @@unique([token])
  @@index([userId])
  @@index([expiresAt])
  @@index([activeOrganizationId])
  @@map("sessions")
}

model Account {
  id                    String    @id @db.VarChar(255)
  accountId             String    @map("account_id") @db.VarChar(255)
  providerId            String    @map("provider_id") @db.VarChar(255)
  userId                String    @map("user_id") @db.VarChar(255)
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   @map("access_token") @db.Text
  refreshToken          String?   @map("refresh_token") @db.Text
  idToken               String?   @map("id_token") @db.Text
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                 String?   @map("scope") @db.Text
  password              String?   @map("password") @db.Text
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@index([providerId])
  @@index([accountId, providerId])
  @@map("accounts")
}

model Verification {
  id         String   @id @db.VarChar(255)
  identifier String   @db.VarChar(255)
  value      String   @db.Text
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([identifier])
  @@index([expiresAt])
  @@map("verifications")
}

model Apikey {
  id                  String  @id @db.VarChar(255)
  name                String? @db.VarChar(255)
  prefix              String  @db.VarChar(20)
  key                 String  @db.Text
  userId              String  @map("user_id") @db.VarChar(255)
  refillInterval      Int?    @map("refill_interval")
  refillAmount        Int?    @map("refill_amount")
  enabled             Boolean @default(true)
  rateLimitEnabled    Boolean @default(true) @map("rate_limit_enabled")
  rateLimitTimeWindow Int?    @map("rate_limit_time_window")
  rateLimitMax        Int?    @map("rate_limit_max")
  requestCount        Int     @default(0) @map("request_count")
  remaining           Int?
  permissions         String? @db.Text
  metadata            String? @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  expiresAt    DateTime? @map("expires_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastRequest  DateTime? @map("last_request")
  lastRefillAt DateTime? @map("last_refill_at")

  @@index([userId])
  @@index([enabled])
  @@index([expiresAt])
  @@index([prefix])
  @@index([key])
  @@map("api_keys")
}

model TwoFactor {
  id          String @id @db.VarChar(255)
  secret      String @db.Text
  backupCodes String @map("backup_codes") @db.Text
  userId      String @map("user_id") @db.VarChar(255)
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("two_factors")
}
